/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var geometry = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPoint();
/***** End of imports. If edited, may not auto-convert in the playground. *****/
/**
 * Título: Clasificación de Coberturas de la Tierra
 * Descripción: Este script es desarrollado en  JavaScript para ser ejecutado en Google Earth Engine.  
 *            Ejecuta un flujo de trabajo completo de clasificación de cobertura de tierra.
 *      
 *            Luego evalúa la exactitud de la clasificación con los datos de validación generados 
 *              con el módulo exec_prepare_data, los cuales fueron almacenados previamente en un asset.
 *  Autora:   Liliana Castillo Villamor
 *  Versión: 1.0
 *  Detalles: El módulo ejecuta un flujo de trabajo completo de clasificación de cobertura de tierra 
 *              usando las funciones disponibles en el módulo classify. 
 *            Utiliza un enfoque de máxima probabilidad basado en los primitivos, 
 *            los cuales se construyen a partir de la imagen de covariables generada previamente con el módulo exec_prepare_data. 
 *            Luego evalúa la exactitud de la clasificación con los datos de validación generados con módulo exec_prepare_data, l
 *            Estos datos de validaciónos fueron almacenados previamente en un asset.  
 * Contacto:  lccastillov@gmail.com
 * Referencias: El Script acá presentado adapta elementos desarrollados por Kyle Woodward para Python (https://github.com/kyle-woodward)
 * 
**/


//Importar módulos
var modulo_classifier=require('users/an-sig/sinchi:classification/classify');
var moduloExecPrepData=require('users/an-sig/sinchi:classification/exec_prepare_data');

//// Obtener variables desde el módulo de preparación de datos
var clase =moduloExecPrepData.clase;
var semestre =moduloExecPrepData.semestre;
var TrainingDataPath=moduloExecPrepData.TrainingDataPath;
var TestingDataPath=moduloExecPrepData.TestingDataPath;
var image_covariatesPath=moduloExecPrepData.image_covariatesPath;
var Region_100K =moduloExecPrepData.Region_100K;
var geometry_test=moduloExecPrepData.geometry_test;
var region=geometry_test;
var ano=moduloExecPrepData.end_year;


var CoberturaTierra = ('projects/pc300-samz-sinchi/assets/coberturas/'
      +semestre+'_'+ ano); 
var geometry = region;


// Cargar los datos de entrenamiento y prueba y la imagen de covariables
//nalmacenados en un asset

var trainingDataUpdated = ee.FeatureCollection(TrainingDataPath);
var testingDataBalanced = ee.FeatureCollection(TestingDataPath);
var image_covariates = ee.Image(image_covariatesPath);

//Crear colección de imágenes de las clases de cobertura de tierra (primitivos)
var primitives=modulo_classifier.createLCPrimitiveCollection(image_covariates, trainingDataUpdated, clase) ;

var multibandImage = primitives.toBands(); // Convertir colección de primitivos en una imagen multibanda


// Ensamblar imagen de clasificación de máxima probabilidad a partir de la colección de primitivos
var assembleMax=modulo_classifier.assembleMaxProbability(primitives);


// Ejecutar la función para agregar la imagen clasificada al mapa
var classifiedImage = ee.Image(assembleMax); // Reemplaza 'tu_imagen_aqui' con el ID de tu imagen


//Matriz de confusion y metricas para clasificador usando primitivos
modulo_classifier.calculateConfusionMatrixB(assembleMax, testingDataBalanced);

// Exportar la imagen clasificada al Asset de GEE

Export.image.toAsset({
    image: classifiedImage,
    description: 'Imagen_clasificada',
    assetId: CoberturaTierra, 
    scale: 20,
    region: geometry_test, 
    maxPixels: 1e9 
});

