var Region_100K = ee.FeatureCollection("projects/pc300-samz-sinchi/assets/Region_100K");

var aoi = Region_100K.first().geometry();
var region = aoi.buffer(100);
var region=geometry;
var geometry = region;
//Decalrar variables
var start_year = 2022;
var start_month = 1;
var start_day = 1;
var end_year = 2022;
var end_month = 7;
var end_day = 31;

var module_extract_samples = require('users/an-sig/sinchi:classification/module_extract_samples');
var moduloComposite= require('users/an-sig/sinchi:classification/composition');
var moduloCovariates= require('users/an-sig/sinchi:classification/covariates');
var modulo_classifier=require('users/an-sig/sinchi:classification/classify');
var clase ='nivel_1'
// Ejecutar la función y recibe los resultados
var visualizationResults = module_extract_samples.executeAndVisualize();
var balanceAndApplyCorrelation=module_extract_samples.balanceAndApplyCorrelation;


// Traer puntos de muestreo para semestre 1 
//Tenemos unafeature collection para muestreos de entrenamiento y validacion
//el atributo (columna) a traves del cual se hara la cllasificacion es nivel_1
var S1_training=visualizationResults.combinedResults_S1.training;
var S1_testing=visualizationResults.combinedResults_S1.testing;
print("S1_testing 30",S1_testing)

print("S1_testing 32",S1_testing)
var processedImage = moduloComposite.s2process(region, start_year, end_year, start_month, start_day,end_month, end_day);

var image_covariates=moduloCovariates.returnCovariates(processedImage,geometry);
var image_covariates=image_covariates.clip(region);

var imageGeometry = image_covariates.geometry();

// Filtrar el FeatureCollection para conservar solo los puntos dentro del extent de la imagen
var S1_training = S1_training.filterBounds(imageGeometry);

//print("image_covariates2",image_covariates);

var bandInfo = processedImage.bandTypes();print('Band Information:', bandInfo);


//primitives
/*
//exportar los training points a un asset
var sampledPtsFromImg = modulo_classifier.PreparePts(S1_training, S1_testing, image_covariates);

var trainingDataUpdated=sampledPtsFromImg.trainingDataUpdated;
var testingDataUpdated=sampledPtsFromImg.testingDataUpdated;
//print("trainingDataUpdated 56",trainingDataUpdated)

// Exportar la colección de entrenamiento
Export.table.toAsset({
  collection: trainingDataUpdated,
  description: 'training_data_export',
  assetId: 'projects/pc300-samz-sinchi/assets/sampling_points/trainingDataUpdated'
});

Export.table.toAsset({
  collection: testingDataUpdated,
  description: 'testing_data_export',
  assetId: 'projects/pc300-samz-sinchi/assets/sampling_points/testingDataUpdated'
});
*/
var trainingDataUpdated = ee.FeatureCollection('projects/pc300-samz-sinchi/assets/sampling_points/trainingDataUpdated')

//Crear colección de primitivos
var primitives=modulo_classifier.createLCPrimitiveCollection(image_covariates, trainingDataUpdated, clase) ;

var multibandImage = primitives.toBands();
print("multibandImage 75",multibandImage)
//mostrar en mapa primeara imagen
var primitivesList = primitives.toList(primitives.size());


// Agregar la primera imagen de la colección al mapa
// Asegurarse de que 'primitives' es una ImageCollection
var firstPrimitiveImage = primitives.first();
//print("firstPrimitiveImage 258",firstPrimitiveImage)

//Visualizar primera imagen
var probabilityBand = firstPrimitiveImage.select('Probability')

// Define los parámetros de visualización
var visParams = {'min': 0, 'max': 1, 'palette': ['blue', 'green', 'red']}  
// Añadir la banda al mapa yCentrar el mapa en la ubicación de la imagen
Map.addLayer(probabilityBand, visParams, 'Probability Band first')
// Opcional: 
Map.centerObject(processedImage);


//// Exportar primitivos a un asset:
// Iterar sobre la lista de imágenes
for (var i = 0; i < primitivesList.size().getInfo(); i++) {
    var image = ee.Image(primitivesList.get(i));
    
    // Define los parámetros de exportación
    var exportParams = {
        'image': image,
        'description': 'Primitive_' + i, // Añade un nombre único para cada exportación
        'assetId': 'projects/pc300-samz-sinchi/assets/primitive_' + i, // Reemplaza con tu ruta de asset
        'scale': 500, 
        'region': region 
    };

    // Exporta la imagen
    Export.image.toAsset(exportParams);
}
